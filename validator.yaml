# Beta-Cooper Validator Configuration (single source of truth)
#
# 所有 validator 管线中的阈值/系数都集中在此文件。
# 设计目标：方便在超大数据集上快速做阈值调参/消融。

extractor:
  # DSSP execution
  dssp_timeout_sec: 5

  # Segment construction (continuous DSSP 'E')
  jump_tolerance: 4
  min_segment_len: 3

  # AlphaFold pLDDT inference from CA B-factor (0..100)
  # Only activates when B-factor distribution looks like pLDDT (predicted models),
  # to avoid gating experimental structures.
  plddt_detection:
    enable: true
    bfactor_min: 0.0
    bfactor_max: 100.0
    median_min: 50.0
    p90_min: 70.0

analyzer:
  # PCA degeneracy guard
  min_axis_variance: 1.0e-5
  axis_dominance_fallback_ratio: 1.15

  # Robust core selection (MinCovDet)
  mcd_support_fraction: 0.75
  mcd_inlier_percentile: 80
  min_core_atoms: 15

  # Final validity threshold
  score_threshold: 0.60

  penalties:
    ellipticity:
      thr: 1.8
      mult: 0.6

    stability:
      cov_eigen_ratio_thr: 50.0
      mult: 0.05
      max_penalty: 0.30

    ring_cv:
      thr_small: 0.20
      thr_large: 0.25
      mult_small: 3.5
      mult_large: 2.5

    thickness:
      thr_small: 0.25
      thr_large: 0.30
      mult_small: 3.0
      mult_large: 2.5

    kurtosis:
      # only used when sample is not small
      thick_thr: 0.35
      kurtosis_thr: -1.0
      penalty_if_thick: 0.5
      penalty_else: 0.1

    angular_gap:
      thr_deg: 60.0
      mult: 0.01   # (gap-thr)*mult  ; matches previous (gap-thr)/100

    z_profile:
      thr_cv: 0.30
      penalty: 0.30

    fallback:
      penalty: 0.15

    segments:
      min_segments: 3
      penalty: 0.25

    surface_rmse_norm:
      thr: 0.25
      mult: 1.5

# Topology / DSSP derived checks
# (using strand ordering produced by geometry.cleaner+topology)

_topology_common:
  # Strong H-bond definition (DSSP energy cutoff, kcal/mol)
  energy_cutoff: -0.5
  min_hbonds_per_edge: 2

  # Mapping aligned strand coords back to residues via KDTree
  nn_dist_tol: 0.75

  # Radial unimodality detection
  radial_min_rel_height: 0.15

validator:
  # Global confidence threshold applied after topology_quality scaling
  confidence_threshold: 0.60

  # Optional combined topology quality scaling (0..1) applied to confidence
  topology_quality:
    enable: true
    apply_to_confidence: true
    components:
      - name: graph_cyclicity
        weight: 1.0
        transform: clip01
      - name: graph_connected
        weight: 1.0
        transform: clip01
      - name: degree2_fraction
        weight: 1.0
        transform: clip01
      - name: radial_unimodal_score
        weight: 1.0
        transform: clip01
      - name: edge_hbond_cv
        weight: 1.0
        transform: inv1p
      - name: registry_shift_edge_mean_std
        weight: 1.0
        transform: exp_decay
        scale: 3.0
      - name: tilt_angle_std_deg
        weight: 1.0
        transform: exp_decay
        scale: 25.0
      - name: vector_alt_score
        weight: 1.0
        transform: neg_clip01

  # Optional pLDDT gate (only when extractor marks plddt_active=1)
  plddt_gate:
    enable: true
    threshold: 0.70
    mean_min: 0.70
    pass_fraction_min: 0.85

  # Hard-fail logic (conservative defaults)
  hard_fail:
    cyclicity_required: 1.0
    graph_connected_required: 1.0
    degree2_fraction_min: 0.75

    vector_alt_max: -0.25     # fail if vector_alt_score > this

    radial_unimodal_min: 0.50
    tilt_std_max_deg: 30.0

    registry_std_max: 4.0

    hbond_uniformity:
      mean_min: 2.0
      cv_max: 1.2

  # If still valid after hard checks, enforce the final confidence threshold
  enforce_confidence_threshold: true

